Refactor unwinding code to improve testability, add tests for unwinding.